import streamlit as st
import pandas as pd
import requests
import urllib3

# SSL ê²½ê³  ë¬´ì‹œ
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ---------------------------------------------------------
# 1. ì„¤ì •
# ---------------------------------------------------------
st.set_page_config(page_title="ê´€ì¸¡ì†Œ ì¡°íšŒ (ë¹„ìƒëª¨ë“œ)", layout="wide")
st.title("ğŸ›¡ï¸ ê´€ì¸¡ì†Œ ì¡°íšŒ (ì°¨ë‹¨ ë°©ì§€ + ë¹„ìƒ ëª©ë¡)")
st.caption("ì„œë²„ ì°¨ë‹¨ ì‹œ, ë‚´ì¥ëœ ì£¼ìš” ì§€ì  ëª©ë¡ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.")

HRFCO_KEY = "F09631CC-1CFB-4C55-8329-BE03A787011E"
try:
    DATA_GO_KEY = st.secrets["public_api_key"]
except:
    DATA_GO_KEY = "5e7413b16c759d963b94776062c5a130c3446edf4d5f7f77a679b91bfd437912"

# [ê°•ë ¥í•œ ì‹ ë¶„ì¦ í—¤ë”]
HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/json',
    'Connection': 'keep-alive'
}

# ---------------------------------------------------------
# 2. [ì¹˜íŠ¸í‚¤] ê¸ˆê°• ìˆ˜ê³„ ì£¼ìš” ì§€ì  ìˆ˜ë™ ë¦¬ìŠ¤íŠ¸
# ---------------------------------------------------------
def get_manual_fallback_list():
    """
    APIê°€ ì°¨ë‹¨ë‹¹í–ˆì„ ë•Œ ë³´ì—¬ì¤„ ê¸ˆê°• ìˆ˜ê³„ ì•Œì§œë°°ê¸° ë¦¬ìŠ¤íŠ¸
    """
    data = [
        # --- ê°‘ì²œ ---
        {'ê´€ì¸¡ì†Œëª…': 'ëŒ€ì „ì‹œ(ê°‘ì²œêµ)', 'ì½”ë“œ': '3009660', 'ì£¼ì†Œ': 'ëŒ€ì „ê´‘ì—­ì‹œ ì„œêµ¬ ì›”í‰ë™'},
        {'ê´€ì¸¡ì†Œëª…': 'ëŒ€ì „ì‹œ(ì›ì´Œêµ)', 'ì½”ë“œ': '3009670', 'ì£¼ì†Œ': 'ëŒ€ì „ê´‘ì—­ì‹œ ëŒ€ë•êµ¬ ëŒ€í™”ë™'},
        {'ê´€ì¸¡ì†Œëª…': 'ëŒ€ì „ì‹œ(ì¸ì°½êµ)', 'ì½”ë“œ': '3009640', 'ì£¼ì†Œ': 'ëŒ€ì „ê´‘ì—­ì‹œ ì¤‘êµ¬ ì‚°ì„±ë™'},
        
        # --- ì´ì›/ì˜¥ì²œ ---
        {'ê´€ì¸¡ì†Œëª…': 'ì˜¥ì²œêµ°(ì´ì›êµ)', 'ì½”ë“œ': '3008680', 'ì£¼ì†Œ': 'ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ° ì´ì›ë©´'},
        {'ê´€ì¸¡ì†Œëª…': 'ì˜¥ì²œêµ°(ì˜¥ì²œëŒ€êµ)', 'ì½”ë“œ': '3008655', 'ì£¼ì†Œ': 'ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ° ë™ì´ë©´'},
        
        # --- 4ëŒ€ê°• ë³´ ---
        {'ê´€ì¸¡ì†Œëª…': 'ì„¸ì¢…ë³´', 'ì½”ë“œ': '3012650', 'ì£¼ì†Œ': 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ ì—°ê¸°ë©´'},
        {'ê´€ì¸¡ì†Œëª…': 'ê³µì£¼ë³´', 'ì½”ë“œ': '3012640', 'ì£¼ì†Œ': 'ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ ìš°ì„±ë©´'},
        {'ê´€ì¸¡ì†Œëª…': 'ë°±ì œë³´', 'ì½”ë“œ': '3012620', 'ì£¼ì†Œ': 'ì¶©ì²­ë‚¨ë„ ë¶€ì—¬êµ° ë¶€ì—¬ì'},
        
        # --- ëŒ/ì£¼ìš” êµëŸ‰ ---
        {'ê´€ì¸¡ì†Œëª…': 'ëŒ€ì²­ëŒ', 'ì½”ë“œ': '1003660', 'ì£¼ì†Œ': 'ëŒ€ì „ê´‘ì—­ì‹œ ëŒ€ë•êµ¬ ë¯¸í˜¸ë™'},
        {'ê´€ì¸¡ì†Œëª…': 'ê³µì£¼ì‹œ(ê¸ˆê°•êµ)', 'ì½”ë“œ': '3012630', 'ì£¼ì†Œ': 'ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ ì‹ ê´€ë™'},
        {'ê´€ì¸¡ì†Œëª…': 'ë¶€ì—¬êµ°(ë°±ì œêµ)', 'ì½”ë“œ': '3012660', 'ì£¼ì†Œ': 'ì¶©ì²­ë‚¨ë„ ë¶€ì—¬êµ° ë¶€ì—¬ì'},
    ]
    return pd.DataFrame(data)

# ---------------------------------------------------------
# 3. ìˆ˜ìœ„ ê´€ì¸¡ì†Œ ê°€ì ¸ì˜¤ê¸° (API ì‹œë„ -> ì‹¤íŒ¨ì‹œ ìˆ˜ë™)
# ---------------------------------------------------------
def get_hrfco_stations():
    url = f"http://api.hrfco.go.kr/{HRFCO_KEY}/waterlevel/list.json"
    
    try:
        # API ì ‘ì† ì‹œë„
        response = requests.get(url, headers=HEADERS, verify=False, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            if 'content' in data:
                df = pd.DataFrame(data['content'])
                # í•œê¸€ ë³€í™˜
                df = df.rename(columns={
                    'wlobscd': 'ì½”ë“œ', 'obsnm': 'ê´€ì¸¡ì†Œëª…', 'addr': 'ì£¼ì†Œ', 'agcnm': 'ê´€ë¦¬ê¸°ê´€'
                })
                # í•„í„°ë§ ì—†ì´ ì£¼ìš” ì»¬ëŸ¼ ì •ë¦¬
                cols = ['ê´€ì¸¡ì†Œëª…', 'ì½”ë“œ', 'ì£¼ì†Œ', 'ê´€ë¦¬ê¸°ê´€']
                final_cols = [c for c in cols if c in df.columns] + [c for c in df.columns if c not in cols]
                return df[final_cols], "API ì ‘ì† ì„±ê³µ (ì „ì²´ ëª©ë¡)"
    except:
        pass # ì—ëŸ¬ë‚˜ë©´ ë°”ë¡œ ë°‘ìœ¼ë¡œ ë„˜ì–´ê°
    
    # [ë¹„ìƒ] API ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
    return get_manual_fallback_list(), "âš ï¸ API ì°¨ë‹¨ë¨ (ë¹„ìƒìš© ìˆ˜ë™ ëª©ë¡ í‘œì‹œ)"

# ---------------------------------------------------------
# 4. ìˆ˜ì§ˆ ì¸¡ì •ì†Œ ê°€ì ¸ì˜¤ê¸° (í™˜ê²½ê³µë‹¨)
# ---------------------------------------------------------
def get_nier_stations():
    url = "http://apis.data.go.kr/1480523/WaterQualityService/getMsrstnList"
    params = {"serviceKey": DATA_GO_KEY, "numOfRows": "3000", "pageNo": "1", "returnType": "json"}
    
    try:
        response = requests.get(url, params=params, headers=HEADERS, timeout=10)
        data = response.json()
        if 'getMsrstnList' in data:
            df = pd.DataFrame(data['getMsrstnList']['item'])
            df = df.rename(columns={'ptNo': 'ì½”ë“œ', 'ptNm': 'ì¸¡ì •ì†Œëª…', 'addr': 'ì£¼ì†Œ', 'deptNm': 'ê´€ë¦¬ë¶€ì„œ'})
            
            cols = ['ì¸¡ì •ì†Œëª…', 'ì½”ë“œ', 'ì£¼ì†Œ', 'ê´€ë¦¬ë¶€ì„œ']
            final_cols = [c for c in cols if c in df.columns]
            return df[final_cols], "API ì ‘ì† ì„±ê³µ"
    except:
        # ìˆ˜ì§ˆë„ ì‹¤íŒ¨ ì‹œ ì£¼ìš” ì§€ì  ìˆ˜ë™ ë°˜í™˜
        fallback = [
            {'ì¸¡ì •ì†Œëª…': 'ì´ì›', 'ì½”ë“œ': '1003A07', 'ì£¼ì†Œ': 'ì¶©ë¶ ì˜¥ì²œêµ°'},
            {'ì¸¡ì •ì†Œëª…': 'ê°‘ì²œ1', 'ì½”ë“œ': '2014A20', 'ì£¼ì†Œ': 'ëŒ€ì „'},
            {'ì¸¡ì •ì†Œëª…': 'ëŒ€ì²­í˜¸(ì¶”ì†Œ)', 'ì½”ë“œ': '1003A05', 'ì£¼ì†Œ': 'ì¶”ì†Œë¦¬'},
            {'ì¸¡ì •ì†Œëª…': 'ê³µì£¼ë³´', 'ì½”ë“œ': '2015A30', 'ì£¼ì†Œ': 'ê³µì£¼'},
        ]
        return pd.DataFrame(fallback), "âš ï¸ API ì ‘ì† ì‹¤íŒ¨ (ìˆ˜ë™ ëª©ë¡)"

# ---------------------------------------------------------
# 5. ë©”ì¸ í™”ë©´
# ---------------------------------------------------------
tab1, tab2 = st.tabs(["ğŸŒŠ ìˆ˜ìœ„ ê´€ì¸¡ì†Œ (ê°‘ì²œ/ì´ì› ë“±)", "ğŸ§ª ìˆ˜ì§ˆ ì¸¡ì •ì†Œ"])

with tab1:
    if st.button("ìˆ˜ìœ„ ê´€ì¸¡ì†Œ ì¡°íšŒ", type="primary"):
        with st.spinner("ëª©ë¡ í™•ì¸ ì¤‘..."):
            df, msg = get_hrfco_stations()
            
            if "ì°¨ë‹¨" in msg:
                st.warning(f"{msg} - ì„œë²„ ë³´ì•ˆ ë¬¸ì œë¡œ ì „ì²´ ëª©ë¡ ëŒ€ì‹  **ì£¼ìš” ì§€ì (ê°‘ì²œ, ì´ì›, ë³´)** ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")
            else:
                st.success(msg)
                
            st.dataframe(df, use_container_width=True, hide_index=True)
            
            # ì—¬ê¸°ì„œ ì½”ë“œì™€ ì´ë¦„ì„ í™•ì¸í•˜ì„¸ìš”!
            st.markdown("""
            ### ğŸ“Œ ì£¼ìš” ì§€ì  ì½”ë“œ í™•ì¸ (ë³µì‚¬í•´ì„œ ì“°ì„¸ìš”)
            - **ëŒ€ì „ ê°‘ì²œ(ê°‘ì²œêµ):** `3009660`
            - **ì˜¥ì²œ ì´ì›(ì´ì›êµ):** `3008680`
            - **ê³µì£¼ë³´:** `3012640`
            - **ëŒ€ì²­ëŒ:** `1003660`
            """)

with tab2:
    if st.button("ìˆ˜ì§ˆ ì¸¡ì •ì†Œ ì¡°íšŒ", type="secondary"):
        with st.spinner("ëª©ë¡ í™•ì¸ ì¤‘..."):
            df_q, msg_q = get_nier_stations()
            if "ì‹¤íŒ¨" in msg_q:
                 st.warning(msg_q)
            else:
                 st.success(msg_q)
            st.dataframe(df_q, use_container_width=True, hide_index=True)
