import streamlit as st
import pandas as pd
import requests
import urllib3

# SSL ê²½ê³  ë¬´ì‹œ
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ---------------------------------------------------------
# 1. ì„¤ì •
# ---------------------------------------------------------
st.set_page_config(page_title="ê´€ì¸¡ì†Œ í†µí•© ì¡°íšŒ (ìµœì¢…)", layout="wide")
st.title("ğŸ“‹ ì „êµ­ ìˆ˜ìœ„/ìˆ˜ì§ˆ ê´€ì¸¡ì†Œ ì°¾ê¸° (ì™„ì „íŒ)")
st.caption("ìˆ˜ìœ„ëŠ” API ì‹¤ì‹œê°„ ì¡°íšŒ / ìˆ˜ì§ˆì€ ë‚´ì¥ëœ ì£¼ìš” ëª…ë‹¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")

# API í‚¤ ì„¤ì •
HRFCO_KEY = "F09631CC-1CFB-4C55-8329-BE03A787011E" # ìˆ˜ìœ„
try:
    DATA_GO_KEY = st.secrets["public_api_key"]
except:
    DATA_GO_KEY = "5e7413b16c759d963b94776062c5a130c3446edf4d5f7f77a679b91bfd437912" # ìˆ˜ì§ˆ

HEADERS = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}

# ---------------------------------------------------------
# 2. [ìˆ˜ì§ˆ] ë‚´ì¥ëœ ì£¼ìš” ì¸¡ì •ì†Œ ëª…ë‹¨ (API ê¸°ëŠ¥ ì—†ìŒ ëŒ€ì‘)
# ---------------------------------------------------------
def get_manual_quality_list():
    """
    í™˜ê²½ê³µë‹¨ APIì—ëŠ” ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥ì´ ì—†ìœ¼ë¯€ë¡œ, 
    ê¸ˆê°• ìˆ˜ê³„ ì£¼ìš” ì§€ì  ì½”ë“œë¥¼ ì§ì ‘ ì œê³µí•©ë‹ˆë‹¤.
    """
    data = [
        # [ëŒ€ì²­í˜¸/ì˜¥ì²œ]
        {'ì¸¡ì •ì†Œëª…': 'ì´ì›(ëŒ€ì²­í˜¸ ìƒë¥˜)', 'ì½”ë“œ': '1003A07', 'ì£¼ì†Œ': 'ì¶©ë¶ ì˜¥ì²œêµ° ì´ì›ë©´'},
        {'ì¸¡ì •ì†Œëª…': 'ëŒ€ì²­í˜¸(ì¶”ì†Œ)', 'ì½”ë“œ': '1003A05', 'ì£¼ì†Œ': 'ì¶©ë¶ ì˜¥ì²œêµ° êµ°ë¶ë©´ (ëŒ€ì²­ëŒ ì•)'},
        {'ì¸¡ì •ì†Œëª…': 'ëŒ€ì²­í˜¸(ë¬¸ì˜)', 'ì½”ë“œ': '1003A08', 'ì£¼ì†Œ': 'ì¶©ë¶ ì²­ì£¼ì‹œ ìƒë‹¹êµ¬ ë¬¸ì˜ë©´'},
        {'ì¸¡ì •ì†Œëª…': 'ëŒ€ì²­í˜¸(íšŒë‚¨)', 'ì½”ë“œ': '1003A25', 'ì£¼ì†Œ': 'ì¶©ë¶ ë³´ì€êµ° íšŒë‚¨ë©´'},
        
        # [ê°‘ì²œ/ëŒ€ì „]
        {'ì¸¡ì •ì†Œëª…': 'ê°‘ì²œ1(ì˜¥ê³„êµ)', 'ì½”ë“œ': '2014A20', 'ì£¼ì†Œ': 'ëŒ€ì „ ì¤‘êµ¬ ì˜¥ê³„ë™'},
        {'ì¸¡ì •ì†Œëª…': 'ê°‘ì²œ2(ë§Œë…„êµ)', 'ì½”ë“œ': '2014A22', 'ì£¼ì†Œ': 'ëŒ€ì „ ì„œêµ¬ ë§Œë…„ë™'},
        {'ì¸¡ì •ì†Œëª…': 'ê°‘ì²œ5(ì›ì´Œêµ)', 'ì½”ë“œ': '2014A50', 'ì£¼ì†Œ': 'ëŒ€ì „ ëŒ€ë•êµ¬ ì›ì´Œë™'},
        
        # [4ëŒ€ê°• ë³´]
        {'ì¸¡ì •ì†Œëª…': 'ì„¸ì¢…ë³´', 'ì½”ë“œ': '2015A40', 'ì£¼ì†Œ': 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ'},
        {'ì¸¡ì •ì†Œëª…': 'ê³µì£¼ë³´', 'ì½”ë“œ': '2015A30', 'ì£¼ì†Œ': 'ì¶©ë‚¨ ê³µì£¼ì‹œ'},
        {'ì¸¡ì •ì†Œëª…': 'ë°±ì œë³´', 'ì½”ë“œ': '2015A35', 'ì£¼ì†Œ': 'ì¶©ë‚¨ ë¶€ì—¬êµ°'},
        {'ì¸¡ì •ì†Œëª…': 'ì²­ë²½(ê³µì£¼ ìƒë¥˜)', 'ì½”ë“œ': '2015A60', 'ì£¼ì†Œ': 'ì¶©ë‚¨ ê³µì£¼ì‹œ ë°˜í¬ë©´'},
    ]
    return pd.DataFrame(data)

# ---------------------------------------------------------
# 3. [ìˆ˜ìœ„] í•œê°•í™ìˆ˜í†µì œì†Œ ëª©ë¡ ì¡°íšŒ (API ì‚¬ìš©)
# ---------------------------------------------------------
def get_hrfco_stations():
    url = f"http://api.hrfco.go.kr/{HRFCO_KEY}/waterlevel/list.json"
    
    try:
        # API í˜¸ì¶œ
        response = requests.get(url, headers=HEADERS, verify=False, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            if 'content' in data:
                df = pd.DataFrame(data['content'])
                
                # í•œê¸€ ì´ë¦„í‘œ ë¶™ì´ê¸°
                rename_map = {
                    'wlobscd': 'ì½”ë“œ', 
                    'obsnm': 'ê´€ì¸¡ì†Œëª…', 
                    'addr': 'ì£¼ì†Œ', 
                    'agcnm': 'ê´€ë¦¬ê¸°ê´€'
                }
                df = df.rename(columns=rename_map)
                
                # ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬
                cols = ['ê´€ì¸¡ì†Œëª…', 'ì½”ë“œ', 'ì£¼ì†Œ', 'ê´€ë¦¬ê¸°ê´€']
                final_cols = [c for c in cols if c in df.columns]
                
                return df[final_cols], "âœ… API ì¡°íšŒ ì„±ê³µ (ì „ì²´ ëª©ë¡)"
    except:
        pass
    
    # ì‹¤íŒ¨ ì‹œ ë³´ì—¬ì¤„ ë¹„ìƒìš© ìˆ˜ìœ„ ê´€ì¸¡ì†Œ ëª©ë¡
    fallback = [
        {'ê´€ì¸¡ì†Œëª…': 'ì˜¥ì²œêµ°(ì´ì›êµ)', 'ì½”ë“œ': '3008680', 'ì£¼ì†Œ': 'ì¶©ë¶ ì˜¥ì²œêµ° ì´ì›ë©´'},
        {'ê´€ì¸¡ì†Œëª…': 'ëŒ€ì „ì‹œ(ê°‘ì²œêµ)', 'ì½”ë“œ': '3009660', 'ì£¼ì†Œ': 'ëŒ€ì „ ì„œêµ¬ ì›”í‰ë™'},
        {'ê´€ì¸¡ì†Œëª…': 'ê³µì£¼ë³´', 'ì½”ë“œ': '3012640', 'ì£¼ì†Œ': 'ì¶©ë‚¨ ê³µì£¼ì‹œ'},
        {'ê´€ì¸¡ì†Œëª…': 'ëŒ€ì²­ëŒ', 'ì½”ë“œ': '1003660', 'ì£¼ì†Œ': 'ëŒ€ì „ ëŒ€ë•êµ¬'},
    ]
    return pd.DataFrame(fallback), "âš ï¸ API ì°¨ë‹¨ë¨ (ë¹„ìƒìš© ëª©ë¡ í‘œì‹œ)"

# ---------------------------------------------------------
# 4. ë©”ì¸ í™”ë©´
# ---------------------------------------------------------
tab1, tab2 = st.tabs(["ğŸŒŠ ìˆ˜ìœ„ ê´€ì¸¡ì†Œ (API)", "ğŸ§ª ìˆ˜ì§ˆ ì¸¡ì •ì†Œ (ë‚´ì¥ëª©ë¡)"])

# íƒ­ 1: ìˆ˜ìœ„
with tab1:
    if st.button("ìˆ˜ìœ„ ê´€ì¸¡ì†Œ ì¡°íšŒ", type="primary"):
        with st.spinner("í•œê°•í™ìˆ˜í†µì œì†Œ ì ‘ì† ì¤‘..."):
            df, msg = get_hrfco_stations()
            
            if "ì°¨ë‹¨" in msg:
                st.warning(msg)
            else:
                st.success(msg)
                
            # ê²€ìƒ‰ì°½
            search = st.text_input("ìˆ˜ìœ„ ê´€ì¸¡ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°‘ì²œ, ì´ì›)", key="s_w")
            if search:
                mask = df.astype(str).apply(lambda x: x.str.contains(search, na=False)).any(axis=1)
                st.dataframe(df[mask], use_container_width=True, hide_index=True)
            else:
                st.dataframe(df, use_container_width=True, hide_index=True)

# íƒ­ 2: ìˆ˜ì§ˆ
with tab2:
    if st.button("ìˆ˜ì§ˆ ì¸¡ì •ì†Œ ì¡°íšŒ", type="primary"):
        # ìˆ˜ì§ˆì€ API í˜¸ì¶œ ì—†ì´ ë°”ë¡œ ë‚´ì¥ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤ (404 ë°©ì§€)
        df_q = get_manual_quality_list()
        
        st.success("âœ… ì£¼ìš” ìˆ˜ì§ˆ ì¸¡ì •ì†Œ ëª©ë¡ (ë‚´ì¥ ë°ì´í„°)")
        st.info("í™˜ê²½ê³µë‹¨ APIëŠ” ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ ì•Šì•„, ì£¼ìš” ì§€ì  ì½”ë“œë¥¼ ë¯¸ë¦¬ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.")
        
        st.dataframe(df_q, use_container_width=True, hide_index=True)
        
        st.markdown("### ğŸ’¡ íŒ: ì´ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ë¶„ì„ì— ì‚¬ìš©í•˜ì„¸ìš”!")
        st.code("""
# ì£¼ìš” ì§€ì  ì½”ë“œ
ì´ì›(ìˆ˜ì§ˆ): 1003A07
ê°‘ì²œ(ìˆ˜ì§ˆ): 2014A20
ê³µì£¼ë³´(ìˆ˜ì§ˆ): 2015A30
        """)
